<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VLOSLP 5-Year Mortality Risk Calculator</title>
    <!-- Bootstrap CSS for a clean, professional medical UI -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; padding-top: 40px; padding-bottom: 40px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .calculator-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.08); max-width: 700px; margin: auto; border-top: 5px solid #0d6efd; }
        .result-box { background: #e9ecef; padding: 25px; border-radius: 8px; text-align: center; margin-top: 25px; border: 1px solid #dee2e6; }
        .form-switch .form-check-input { width: 2.5em; height: 1.25em; cursor: pointer; }
        .form-check-label { margin-left: 10px; cursor: pointer; font-weight: 500; color: #495057; }
        .section-title { font-size: 1.1rem; color: #6c757d; border-bottom: 2px solid #f8f9fa; padding-bottom: 5px; margin-top: 20px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div class="calculator-card">
        <h2 class="mb-1 text-center">VLOSLP Mortality Calculator</h2>
        <p class="text-muted text-center mb-4">Predicts mortality risk in older adults with Very-Late-Onset Schizophrenia-Like Psychosis</p>
        
        <!-- Demographics Section -->
        <div class="section-title">Demographics</div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label fw-bold">Age at Onset (Years)</label>
                <input type="number" id="onset_age" class="form-control" value="75" min="60" max="110">
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold">Biological Sex</label>
                <select id="sex" class="form-select">
                    <!-- Update the values based on how your R model coded sex (0 vs 1) -->
                    <option value="0">Female</option>
                    <option value="1">Male</option>
                </select>
            </div>
        </div>

        <!-- Comorbidities Section -->
        <div class="section-title">Comorbidities</div>
        <div class="row">
            <!-- Left Column -->
            <div class="col-md-6">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="rf">
                    <label class="form-check-label" for="rf">Renal Failure (rf)</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="ld">
                    <label class="form-check-label" for="ld">Liver Disease (ld)</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="pvd">
                    <label class="form-check-label" for="pvd">Peripheral Vascular Disease (pvd)</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="coag">
                    <label class="form-check-label" for="coag">Coagulopathy (coag)</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="valv">
                    <label class="form-check-label" for="valv">Valvular Disease (valv)</label>
                </div>
            </div>
            
            <!-- Right Column -->
            <div class="col-md-6">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="pcd">
                    <label class="form-check-label" for="pcd">Pulmonary Circulation Disease (pcd)</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="solidtum">
                    <label class="form-check-label" for="solidtum">Solid Tumor (solidtum)</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="lymph">
                    <label class="form-check-label" for="lymph">Lymphoma (lymph)</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="metacanc">
                    <label class="form-check-label" for="metacanc">Metastatic Cancer (metacanc)</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="aids">
                    <label class="form-check-label" for="aids">HIV / AIDS (aids)</label>
                </div>
            </div>
        </div>

        <button class="btn btn-primary btn-lg w-100 mt-3" onclick="calculateRisk()">Calculate Mortality Risk</button>

        <!-- The Output Area -->
        <div class="result-box mt-4">
            <h5 class="text-secondary">Estimated Mortality Risk:</h5>
            <h1 id="result" class="text-danger fw-bold" style="font-size: 3.5rem;">-- %</h1>
        </div>
    </div>
</div>

<!-- The Math (JavaScript) -->
<script>
    function calculateRisk() {
        // 1. Get user inputs
        let age = parseFloat(document.getElementById('onset_age').value);
        let sex = parseFloat(document.getElementById('sex').value);
        
        // Convert toggle switches to 1 (checked) or 0 (unchecked)
        let rf = document.getElementById('rf').checked ? 1 : 0;
        let ld = document.getElementById('ld').checked ? 1 : 0;
        let lymph = document.getElementById('lymph').checked ? 1 : 0;
        let metacanc = document.getElementById('metacanc').checked ? 1 : 0;
        let solidtum = document.getElementById('solidtum').checked ? 1 : 0;
        let pvd = document.getElementById('pvd').checked ? 1 : 0;
        let coag = document.getElementById('coag').checked ? 1 : 0;
        let valv = document.getElementById('valv').checked ? 1 : 0;
        let pcd = document.getElementById('pcd').checked ? 1 : 0;
        let aids = document.getElementById('aids').checked ? 1 : 0;

        // 2. The Beta Coefficients from your R model
        let b_age = 0.06231;
        let b_sex = 0.54207;
        let b_rf = 0.37804;
        let b_ld = 0.13423;
        let b_lymph = 0.66777;
        let b_metacanc = 1.24170;
        let b_solidtum = 0.42906;
        let b_pvd = 0.09546;
        let b_coag = 0.10323;
        let b_valv = 0.14195;
        let b_pcd = 0.14799;
        let b_aids = 0.75431;

        // --- IMPORTANT VARIABLES YOU MUST VERIFY ---
        // A. Baseline Survival (S0) at your specific time point (e.g., 5 years)
        // You can find this using basehaz() in R. 
        let S0 = 0.4632; 

        // B. Mean Age (if your model centered the age variable, which `rms::cph` does by default)
        // If your R model subtracted the mean age before fitting, enter that mean age here. 
        // If it did NOT center the age, leave this as 0.
        let mean_age = 75.35; 
        
        // ------------------------------------------

        // 3. Calculate the Linear Predictor (Prognostic Index)
        let PI = (b_age * (age - mean_age)) + 
                 (b_sex * sex) + 
                 (b_rf * rf) + 
                 (b_ld * ld) + 
                 (b_lymph * lymph) + 
                 (b_metacanc * metacanc) + 
                 (b_solidtum * solidtum) + 
                 (b_pvd * pvd) + 
                 (b_coag * coag) + 
                 (b_valv * valv) + 
                 (b_pcd * pcd) + 
                 (b_aids * aids);

        // 4. Calculate final survival and mortality
        let survivalProb = Math.pow(S0, Math.exp(PI));
        
        // Ensure probability doesn't exceed bounds due to extreme inputs
        if (survivalProb > 1) survivalProb = 1;
        if (survivalProb < 0) survivalProb = 0;

        let mortalityRisk = (1 - survivalProb) * 100;

        // 5. Display the result on the screen
        document.getElementById('result').innerText = mortalityRisk.toFixed(1) + "%";
    }
</script>

</body>
</html>
