<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VLOSLP 5-Year Mortality Risk Calculator</title>
    <!-- Bootstrap CSS for layout -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js for the Survival Curve -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f7f6; padding-top: 30px; padding-bottom: 40px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .calculator-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.08); margin-bottom: 30px; border-top: 5px solid #0d6efd; }
        .result-box { background: #e9ecef; padding: 25px; border-radius: 8px; text-align: center; border: 1px solid #dee2e6; height: 100%; display: flex; flex-direction: column; justify-content: center; }
        .form-switch .form-check-input { width: 2.5em; height: 1.25em; cursor: pointer; }
        .form-check-label { margin-left: 10px; cursor: pointer; font-weight: 500; color: #495057; }
        .section-title { font-size: 1.1rem; color: #6c757d; border-bottom: 2px solid #f8f9fa; padding-bottom: 5px; margin-top: 20px; margin-bottom: 15px; }
        canvas { max-height: 350px; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-1 text-center">VLOSLP Mortality Calculator</h2>
    <p class="text-muted text-center mb-4">Predicts mortality risk in older adults with Very-Late-Onset Schizophrenia-Like Psychosis</p>
    
    <div class="row">
        <!-- LEFT COLUMN: INPUTS -->
        <div class="col-lg-7">
            <div class="calculator-card">
                <!-- Demographics -->
                <div class="section-title mt-0">Patient Demographics</div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Age at Onset (Years)</label>
                        <input type="number" id="onset_age" class="form-control" value="75" min="60" max="110">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Biological Sex</label>
                        <select id="sex" class="form-select">
                            <option value="0">Female</option>
                            <option value="1">Male</option>
                        </select>
                    </div>
                </div>

                <!-- Comorbidities -->
                <div class="section-title">Comorbidities</div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="rf"><label class="form-check-label" for="rf">Renal Failure (rf)</label></div>
                        <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="ld"><label class="form-check-label" for="ld">Liver Disease (ld)</label></div>
                        <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="pvd"><label class="form-check-label" for="pvd">Peripheral Vascular Dis.</label></div>
                        <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="coag"><label class="form-check-label" for="coag">Coagulopathy</label></div>
                        <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="valv"><label class="form-check-label" for="valv">Valvular Disease</label></div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="pcd"><label class="form-check-label" for="pcd">Pulmonary Circ. Dis.</label></div>
                        <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="solidtum"><label class="form-check-label" for="solidtum">Solid Tumor</label></div>
                        <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="lymph"><label class="form-check-label" for="lymph">Lymphoma</label></div>
                        <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="metacanc"><label class="form-check-label" for="metacanc">Metastatic Cancer</label></div>
                        <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="aids"><label class="form-check-label" for="aids">HIV / AIDS</label></div>
                    </div>
                </div>

                <button class="btn btn-primary btn-lg w-100 mt-4" onclick="calculateRisk()">Calculate Predictions</button>
            </div>
        </div>

        <!-- RIGHT COLUMN: OUTPUTS (Summary & Chart) -->
        <div class="col-lg-5">
            <!-- Big Number Result -->
            <div class="calculator-card mb-4" style="padding: 20px;">
                <div class="result-box">
                    <h5 class="text-secondary">Estimated 5-Year Mortality Risk</h5>
                    <h1 id="result" class="text-danger fw-bold" style="font-size: 3.5rem;">-- %</h1>
                    <p class="mb-0 text-muted" id="surv-text">Survival Probability: -- %</p>
                </div>
            </div>

            <!-- Summary Table -->
            <div class="calculator-card mb-4" style="padding: 20px;">
                <h5 class="text-center mb-3">Model Summary</h5>
                <table class="table table-sm table-bordered mb-0">
                    <tbody>
                        <tr><td class="bg-light"><strong>Prognostic Index (PI)</strong></td><td id="table-pi">--</td></tr>
                        <tr><td class="bg-light"><strong>Hazard Ratio (vs Average)</strong></td><td id="table-hr">--</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- BOTTOM ROW: SURVIVAL PLOT -->
    <div class="row">
        <div class="col-12">
            <div class="calculator-card">
                <h5 class="text-center mb-3">Predicted Survival Curve (0 to 5 Years)</h5>
                <canvas id="survivalChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize empty chart variable
    let survivalChartInstance = null;

    // --- YOUR R MODEL BASELINE SURVIVAL ARRAYS ---
    // To make a curve, you need the baseline survival at multiple time points (Years 1, 2, 3, 4, 5).
    // REPLACE THESE WITH YOUR ACTUAL basehaz() NUMBERS AT DAYS 365, 730, 1095, 1460, 1825.
    const timePoints = [0, 1, 2, 3, 4, 5]; // Years
    const baselineSurvival = [1.0000, 0.8513, 0.7587, 0.6716, 0.5824, 0.5368]; // Example S0 values
    
    function calculateRisk() {
        // 1. Get Inputs
        let age = parseFloat(document.getElementById('onset_age').value);
        let sex = parseFloat(document.getElementById('sex').value);
        
        let rf = document.getElementById('rf').checked ? 1 : 0; let ld = document.getElementById('ld').checked ? 1 : 0;
        let lymph = document.getElementById('lymph').checked ? 1 : 0; let metacanc = document.getElementById('metacanc').checked ? 1 : 0;
        let solidtum = document.getElementById('solidtum').checked ? 1 : 0; let pvd = document.getElementById('pvd').checked ? 1 : 0;
        let coag = document.getElementById('coag').checked ? 1 : 0; let valv = document.getElementById('valv').checked ? 1 : 0;
        let pcd = document.getElementById('pcd').checked ? 1 : 0; let aids = document.getElementById('aids').checked ? 1 : 0;

        // 2. Beta Coefficients
        let b_age = 0.06231; let b_sex = 0.54207; let b_rf = 0.37804; let b_ld = 0.13423;
        let b_lymph = 0.66777; let b_metacanc = 1.24170; let b_solidtum = 0.42906; let b_pvd = 0.09546;
        let b_coag = 0.10323; let b_valv = 0.14195; let b_pcd = 0.14799; let b_aids = 0.75431;

        let mean_age = 0; // Update this!

        // 3. Calculate PI and Hazard Ratio
        let PI = (b_age * (age - mean_age)) + (b_sex * sex) + (b_rf * rf) + (b_ld * ld) + 
                 (b_lymph * lymph) + (b_metacanc * metacanc) + (b_solidtum * solidtum) + 
                 (b_pvd * pvd) + (b_coag * coag) + (b_valv * valv) + (b_pcd * pcd) + (b_aids * aids);
        
        let HR = Math.exp(PI); // Hazard Ratio relative to baseline

        // 4. Update Main Numbers and Table
        let surv5yr = Math.pow(baselineSurvival[5], HR);
        let mort5yr = (1 - surv5yr) * 100;

        document.getElementById('result').innerText = mort5yr.toFixed(1) + "%";
        document.getElementById('surv-text').innerText = "Survival Probability: " + (surv5yr * 100).toFixed(1) + "%";
        document.getElementById('table-pi').innerText = PI.toFixed(3);
        document.getElementById('table-hr').innerText = HR.toFixed(2);

        // 5. Generate Data for the Survival Curve
        let patientSurvivalData = baselineSurvival.map(S0 => Math.pow(S0, HR));

        // 6. Draw/Update the Chart
        drawChart(patientSurvivalData);
    }

    function drawChart(patientData) {
        const ctx = document.getElementById('survivalChart').getContext('2d');
        
        // Destroy old chart if it exists so we can draw a new one
        if (survivalChartInstance) {
            survivalChartInstance.destroy();
        }

        survivalChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timePoints,
                datasets: [{
                    label: 'Predicted Survival Probability',
                    data: patientData,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.3, // Makes the curve smooth
                    pointRadius: 5,
                    pointBackgroundColor: '#0d6efd'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        min: 0,
                        max: 1,
                        title: { display: true, text: 'Survival Probability', font: {weight: 'bold'} }
                    },
                    x: {
                        title: { display: true, text: 'Years Since Onset', font: {weight: 'bold'} }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Survival: ' + (context.parsed.y * 100).toFixed(1) + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Run once on page load to show initial generic data
    window.onload = calculateRisk;
</script>

</body>
</html>
